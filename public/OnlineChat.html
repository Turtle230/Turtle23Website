<!DOCTYPE html>
<html lang="pl-pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turtle23 Official Page - Chat Online</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/styles_online_chat.css" />
</head>
<body>
  <header class="topnav">
    <a href="index.html" class="logo-link">
      <img class="logo" src="images/logo_circle.png" alt="Logo" />
    </a>
    <h1 class="title">Online Chat</h1>
    <div class="hamburger-menu" id="hamburger-menu">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </div>
  </header>

  <nav class="side-menu" id="side-menu">
    <a href="index.html">Home</a>
    <a href="HistoriaSerwera.html">Historia Serwera</a>
    <a href="Podziekowania.html">Podziƒôkowania</a>
    <a href="CentrumInformacyjne.html">Centrum Informacyjne</a>
    <a href="TurtleResourcePack.html" class="login-required">Turtle Resourspacküîí</a>
    <a href="BialaLista.html" class="login-required">Bia≈Ça Listaüîí</a>
    <a href="BlogStanMara.html" class="login-required">Blog StanMaraüîí</a>
    <button type="button" class="login-btn" id="user-button">Login</button>
  </nav>

  <main class="background-container">
    <div class="overlay-box">
      <div class="chat-menu">
        <h2>Twoje rozmowy</h2>
        <ul id="conversation-list" class="conversation-list">
          <li>≈Åadowanie rozm√≥w...</li>
        </ul>
        <button id="new-chat-btn">+ Nowa rozmowa</button>
      </div>
    </div>
  </main>

  <footer class="footer_class">
    <a class="footer_text" href="">Strona zosta≈Ça stworzona przez Polskiego Pelikana! :)</a>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
<script>
  let isLoadingConversations = false;

  async function loadConversations() {
    if (isLoadingConversations) {
      console.warn('‚è≥ ≈Åadowanie rozm√≥w ju≈º trwa ‚Äî pomijam kolejne wywo≈Çanie.');
      return;
    }

    isLoadingConversations = true;
    console.log('üöÄ Wywo≈Çano loadConversations');

    const convoList = document.getElementById('conversation-list');
    if (!convoList) {
      console.error('‚ùå Nie znaleziono elementu #conversation-list');
      isLoadingConversations = false;
      return;
    }

    // üîÑ Diagnostyczne czyszczenie listy
    console.log('üßπ Czyszczenie listy rozm√≥w...');
    while (convoList.firstChild) {
      convoList.removeChild(convoList.firstChild);
    }

    try {
      const res = await fetch('/api/chat/conversations');
      const conversations = await res.json();

      console.log(`üì¶ Otrzymano ${conversations.length} rozm√≥w z backendu`);
      console.table(conversations);

      if (conversations.length === 0) {
        const emptyLi = document.createElement('li');
        emptyLi.textContent = 'Brak rozm√≥w. Kliknij "+ Nowa rozmowa" aby rozpoczƒÖƒá.';
        convoList.appendChild(emptyLi);
        return;
      }

      conversations.forEach((convo, index) => {
        const isGlobal = convo.id === 'global';
        const title = isGlobal ? 'Og√≥lna rozmowa' : (convo.title || convo.peerUsername || 'Rozmowa');

        console.log(`‚ûï Dodajƒô rozmowƒô [${index}]: ${title} (ID: ${convo.id})`);

        const url = `conversation.html?convoId=${encodeURIComponent(convo.id)}&title=${encodeURIComponent(title)}`;

        const li = document.createElement('li');
        li.setAttribute('data-convo-id', convo.id); // üîç diagnostyczny atrybut

        const a = document.createElement('a');
        a.href = url;
        a.innerHTML = `
          <strong>${isGlobal ? '' + title : title}</strong><br>
          <span>${convo.lastMessagePreview || 'Brak wiadomo≈õci'}</span>
        `;

        if (isGlobal) {
          a.classList.add('global-chat');
          a.style.fontWeight = 'bold';
          a.style.color = '#ffffff';
        }

        li.appendChild(a);
        convoList.appendChild(li);
      });
    } catch (err) {
      const errorLi = document.createElement('li');
      errorLi.textContent = 'B≈ÇƒÖd ≈Çadowania rozm√≥w.';
      convoList.appendChild(errorLi);
      console.error('üí• B≈ÇƒÖd wczytywania rozm√≥w:', err);
    } finally {
      isLoadingConversations = false;
    }
  }

  // ‚úÖ Wywo≈Çanie tylko raz po za≈Çadowaniu DOM
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOMContentLoaded ‚Äî uruchamiam loadConversations');
    loadConversations();
  });

  // üßë‚Äçüíª Obs≈Çuga przycisku "Nowa rozmowa"
  document.getElementById('new-chat-btn').addEventListener('click', async () => {
    const username = prompt('Podaj nazwƒô u≈ºytkownika do rozmowy prywatnej:');
    if (!username) return;

    console.log(`üì® Tworzenie nowej rozmowy z u≈ºytkownikiem: ${username}`);

    try {
      const res = await fetch('/api/chat/conversations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_group: false, participants: [username] })
      });
      const result = await res.json();
      console.log('‚úÖ Nowa rozmowa utworzona:', result);
      loadConversations(); // ponowne za≈Çadowanie po utworzeniu
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd tworzenia rozmowy:', err);
      alert('Nie uda≈Ço siƒô utworzyƒá rozmowy.');
    }
  });
</script>


  <script>
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
      loginForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
          const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const result = await response.json();
          if (result.success) {
            window.location.href = result.redirect;
          } else {
            alert(result.message);
          }
        } catch (err) {
          console.error('Login error:', err);
          alert('WystƒÖpi≈Ç b≈ÇƒÖd logowania.');
        }
      });
    }
  </script>

  <script>
    const hamburgerMenu = document.getElementById('hamburger-menu');
    const sideMenu = document.getElementById('side-menu');

    function spinHamburger(forward = true) {
      const spinClass = forward ? 'spin-forward' : 'spin-backward';
      hamburgerMenu.classList.add(spinClass);
      setTimeout(() => {
        hamburgerMenu.classList.remove('spin-forward', 'spin-backward');
      }, 600);
    }

    hamburgerMenu.addEventListener('click', (event) => {
      const opening = !sideMenu.classList.contains('active');
      sideMenu.classList.toggle('active');
      spinHamburger(opening);
      event.stopPropagation();
    });

    document.addEventListener('click', (event) => {
      if (!sideMenu.contains(event.target) && !hamburgerMenu.contains(event.target)) {
        if (sideMenu.classList.contains('active')) {
          sideMenu.classList.remove('active');
          spinHamburger(false);
        }
      }
    });
  </script>

  <script>
    fetch('/current-user')
      .then(res => res.json())
      .then(data => {
        const isLoggedIn = !!data.username;

        document.querySelectorAll('.login-required').forEach(link => {
          if (!isLoggedIn) {
            link.href = '/error.html';
          } else {
            link.textContent = link.textContent.replace(/üîí/g, '');
          }
        });

        const loginButton = document.getElementById('user-button');
        if (loginButton) {
          if (isLoggedIn) {
            loginButton.innerHTML = `
              <img src="images/user_icon.png" alt="User" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;">
              ${data.username}
            `;
            loginButton.onclick = () => {
              window.location.href = 'UserInterface.html';
            };
          } else {
            loginButton.textContent = 'Login';
            loginButton.onclick = () => {
              window.location.href = 'login.html';
            };
          }
        }
      });
  </script>
</body>
</html>
